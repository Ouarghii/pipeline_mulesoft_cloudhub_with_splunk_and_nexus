name: CI/CD Pipeline GITHUB/CloudHub

permissions:
  contents: write 

on: push
jobs:
  update-pom:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Set up Git identity
        run: |
          git config --global user.email "${{ secrets.GIT_EMAIL }}"
          git config --global user.name "Ferielkraiem2000"  

      - name: Set up Git remote
        run: |
          git remote add dev https://${{ secrets.GIT_TOKEN }}@github.com/Ferielkraiem2000/pipeline_mulesoft_cloudhub.git
          git remote set-url dev https://${{ secrets.GIT_TOKEN }}@github.com/Ferielkraiem2000/pipeline_mulesoft_cloudhub.git
          
      - name: Create and push Maven settings file
        run: |
          
          cat << EOF > settings.xml
          <settings>
            <servers>
              <server>
                <id>anypoint-repo</id>
                <username>${{ secrets.ANYPOINT_CLIENT_ID }}</username>
                <password>${{ secrets.ANYPOINT_CLIENT_SECRET }}</password>
              </server>
              <server>
                <id>github-repo</id>
                <username>${{ secrets.GIT_EMAIL }}</username>
                <password>${{ secrets.GIT_TOKEN }}</password>
              </server>
            </servers>
            <profiles>
              <profile>
                <id>anypoint-profile</id>
                <properties>
                  <anypoint.clientId>${{ secrets.ANYPOINT_CLIENT_ID }}</anypoint.clientId>
                  <anypoint.clientSecret>${{ secrets.ANYPOINT_CLIENT_SECRET }}</anypoint.clientSecret>
                </properties>
              </profile>
              <profile>
                <id>github-profile</id>
                <properties>
                  <github.email>${{ secrets.GIT_EMAIL }}</github.email>
                  <github.token>${{ secrets.GIT_TOKEN }}</github.token>
                </properties>
              </profile>
            </profiles>
            <activeProfiles>
              <activeProfile>anypoint-profile</activeProfile>
              <activeProfile>github-profile</activeProfile>
            </activeProfiles>
          </settings>
          EOF

          git checkout -b ${{ github.ref_name }} || git checkout ${{ github.ref_name }}
          git add settings.xml
          git commit -m "Add Maven settings file" || echo "Nothing to commit"
          git push dev ${{ github.ref_name }}
