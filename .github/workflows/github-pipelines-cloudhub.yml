name: CI/CD Pipeline GITHUB/CloudHub

permissions:
  contents: write 

on: push
jobs:
  
  # Job 1: Create Maven settings file
  create-settings:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Git identity
        run: |
          git config --global user.email "${{ secrets.GIT_EMAIL }}"
          git config --global user.name "Ferielkraiem2000"

      - name: Create and commit Maven settings file
        run: |
          cat << EOF > settings.xml
          <settings>
            <servers>
              <server>
                <id>anypoint-repo</id>
                <username>${{ secrets.ANYPOINT_CLIENT_ID }}</username>
                <password>${{ secrets.ANYPOINT_CLIENT_SECRET }}</password>
              </server>
              <server>
                <id>github-repo</id>
                <username>${{ secrets.GIT_EMAIL }}</username>
                <password>${{ secrets.GIT_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF

          git add settings.xml
          git commit -m "Add Maven settings file" || echo "Nothing to commit"
          git push

  # Job 2: Update Parent POM
  update-parent-pom:
    runs-on: ubuntu-latest
    needs: create-settings  # This job depends on 'create-settings'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Update Parent POM
        run: |
          touch update-parentPOM.sh
          # Code to create and update parent_pom.xml as in your script
          chmod +x update-parentPOM.sh
          ./update-parentPOM.sh

  # Job 3: Update Project POM
  update-project-pom:
    runs-on: ubuntu-latest
    needs: update-parent-pom  # This job depends on 'update-parent-pom'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Update Project POM
        run: |
          touch update-projectPOM.sh
          # Code to update the project's POM file
          chmod +x update-projectPOM.sh
          ./update-projectPOM.sh

  # Job 4: Build Maven Project
  build:
    runs-on: ubuntu-latest
    needs: update-project-pom  # This job depends on 'update-project-pom'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Build with Maven
        run: mvn clean package

  # Job 5: Deploy to CloudHub
  deploy-cloudhub:
    runs-on: ubuntu-latest
    needs: build  # This job depends on 'build'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Deploy to CloudHub
        run: mvn deploy -DmuleDeploy -DskipTests
